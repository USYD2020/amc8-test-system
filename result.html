<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AMC8 测试结果</title>
    
    <!-- 外部资源 -->
    <link href="https://cdn.staticfile.org/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.staticfile.org/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;500;600;700&family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Supabase Client Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --primary-color: #3b82f6;
            --secondary-color: #1e40af;
            --accent-color: #f59e0b;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --dark-bg: #1f2937;
            --dark-card: #374151;
        }

        * {
            font-family: 'Noto Sans SC', Tahoma, Arial, Roboto, "Droid Sans", "Helvetica Neue", "Droid Sans Fallback", "Heiti SC", "Hiragino Sans GB", Simsun, sans-serif;
        }

        body {
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .result-card {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
            transition: all 0.3s ease;
        }

        .score-circle {
            width: auto;
            height: auto;
            border-radius: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            background: transparent;
            padding: 1rem;
        }
        
        .score-progress-container {
            width: 280px;
            height: 20px;
            background: #e5e7eb;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            margin-top: 1rem;
            border: 1px solid #d1d5db;
        }
        
        .score-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #f59e0b 0%, #d97706 100%);
            border-radius: 10px;
            transition: width 1s ease-out;
            width: 0%;
        }
        
        .score-progress-text {
            display: none; /* 隐藏进度条中心文字，避免重复显示 */
        }
        
        /* 屏幕显示时隐藏方块设计，仅PDF显示 */
        .score-blocks-container {
            display: none;
        }

        .score-content {
            text-align: center;
            margin-bottom: 0.5rem;
        }

        .class-badge {
            background: linear-gradient(135deg, var(--class-color, #3b82f6) 0%, var(--class-color-dark, #1e40af) 100%);
            color: white;
            padding: 1rem 2rem;
            border-radius: 2rem;
            font-weight: bold;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
            box-shadow: 0 8px 25px -5px var(--class-color, #3b82f6);
        }

        .subject-bar {
            transition: all 0.8s ease;
            transform-origin: left center;
        }

        .animate-bar {
            animation: growBar 1s ease-out forwards;
        }

        @keyframes growBar {
            from { width: 0%; }
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin: 2rem 0;
            /* 添加flexbox居中布局 */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* 雷达图Canvas高分辨率设置 */
        #radar-chart {
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
            image-rendering: pixelated;
            /* 确保Canvas正确定位 */
            max-width: 100%;
            max-height: 100%;
        }

        /* 祝贺动画样式 */
        .congratulations-banner {
            background: linear-gradient(135deg, 
                rgba(59, 130, 246, 0.9) 0%, 
                rgba(99, 102, 241, 0.8) 50%, 
                rgba(168, 85, 247, 0.9) 100%);
            border-radius: 20px;
            margin-bottom: 2rem;
            overflow: hidden;
            position: relative;
        }

        .congratulations-banner::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            animation: sparkle 3s ease-in-out infinite;
        }

        @keyframes sparkle {
            0%, 100% { transform: rotate(0deg) scale(1); opacity: 0.3; }
            50% { transform: rotate(180deg) scale(1.1); opacity: 0.7; }
        }

        .congratulations-content {
            position: relative;
            z-index: 1;
            padding: 2.5rem;
            text-align: center;
            color: white;
        }

        .congratulations-icon {
            font-size: 3.5rem;
            margin-bottom: 1rem;
            animation: bounce 2s ease-in-out infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        .congratulations-name {
            font-size: 2.8rem;
            font-weight: bold;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            margin-bottom: 0.5rem;
            line-height: 1.2;
        }

        .congratulations-grade {
            display: inline-block;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 0.5rem 1.5rem;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 600;
            margin: 1rem 0;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .congratulations-message {
            font-size: 1.2rem;
            opacity: 0.95;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
            margin-top: 1rem;
            line-height: 1.4;
        }

        /* 导航栏样式优化 - 使用柔和的紫色调 */
        .navbar {
            background: linear-gradient(135deg, 
                rgba(79, 70, 229, 0.9) 0%, 
                rgba(99, 102, 241, 0.85) 50%, 
                rgba(129, 140, 248, 0.8) 100%);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 8px 32px rgba(79, 70, 229, 0.15);
        }

        .navbar .nav-brand-icon {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.1));
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 15px rgba(255, 255, 255, 0.1);
        }

        .navbar .nav-button {
            background: linear-gradient(135deg, 
                rgba(255, 255, 255, 0.2) 0%, 
                rgba(255, 255, 255, 0.15) 100%);
            border: 1px solid rgba(255, 255, 255, 0.25);
            color: white;
            font-weight: 500;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .navbar .nav-button:hover {
            background: linear-gradient(135deg, 
                rgba(255, 255, 255, 0.3) 0%, 
                rgba(255, 255, 255, 0.25) 100%);
            border-color: rgba(255, 255, 255, 0.4);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }

        .navbar .nav-button-success {
            background: linear-gradient(135deg, 
                rgba(16, 185, 129, 0.8) 0%, 
                rgba(5, 150, 105, 0.8) 100%);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.2);
        }

        .navbar .nav-button-success:hover {
            background: linear-gradient(135deg, 
                rgba(16, 185, 129, 0.9) 0%, 
                rgba(5, 150, 105, 0.9) 100%);
            border-color: rgba(255, 255, 255, 0.4);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.3);
        }

        .navbar .nav-text-primary {
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .navbar .nav-text-secondary {
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        /* 深色模式 */
        .dark {
            background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
        }

        .dark .result-card {
            background: rgba(31, 41, 55, 0.95);
            color: #f9fafb;
        }

        .dark .text-gray-900 {
            color: #f9fafb !important;
        }

        .dark .text-gray-600 {
            color: #9ca3af !important;
        }

        .dark .border-gray-200 {
            border-color: #4b5563 !important;
        }

        /* 动画效果 */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-in-up {
            animation: fadeInUp 0.8s ease-out;
        }

        .animate-delay-200 { animation-delay: 0.2s; }
        .animate-delay-400 { animation-delay: 0.4s; }
        .animate-delay-600 { animation-delay: 0.6s; }

        /* 打印专用内容 - 屏幕显示时隐藏 */
        .print-only {
            display: none;
        }

        /* 打印样式 - 全面兼容性重置 */
        @media print {
            @page {
                margin: 1.5cm;
                size: A4;
            }
            
            /* 全局PDF兼容性重置 */
            * {
                -webkit-print-color-adjust: exact !important;
                color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            body {
                background: white !important;
                color: #000000 !important;
                font-family: "Helvetica Neue", Arial, sans-serif !important;
            }
            
            /* 移除所有不兼容的CSS3特效 */
            *,
            *::before,
            *::after {
                backdrop-filter: none !important;
                filter: none !important;
                box-shadow: none !important;
                text-shadow: none !important;
                border-radius: 8px !important; /* 保留基础圆角 */
                transform: none !important;
                transition: none !important;
                animation: none !important;
            }
            .no-print {
                display: none !important;
            }
            .result-card {
                background: white !important;
                backdrop-filter: none !important;
                box-shadow: none !important;
                border: 1px solid #ccc;
                page-break-inside: avoid;
            }
            
            /* 祝贺横幅打印优化 - 完全简化 */
            .congratulations-banner {
                background: #3b82f6 !important;
                border: none !important;
                box-shadow: none !important;
                backdrop-filter: none !important;
                border-radius: 0 !important;
                -webkit-print-color-adjust: exact !important;
                color-adjust: exact !important;
                position: relative !important;
            }
            
            .congratulations-banner * {
                backdrop-filter: none !important;
                box-shadow: none !important;
                text-shadow: none !important;
            }
            
            .congratulations-banner::before {
                display: none !important;
            }
            
            .congratulations-content {
                background: transparent !important;
                backdrop-filter: none !important;
            }

            .congratulations-grade {
                background: #ffffff !important;
                backdrop-filter: none !important;
                border: 2px solid #1e40af !important;
                color: #1e40af !important;
                box-shadow: none !important;
                text-shadow: none !important;
            }
            
            /* 导航栏打印隐藏（已有no-print类） */
            .navbar {
                display: none !important;
            }
            
            /* 雷达图打印优化 - 隐藏Canvas显示打印图片 */
            .chart-container canvas {
                display: none !important;
            }
            
            /* 雷达图容器打印时适中尺寸 - 缩小以提高清晰度并居中 */
            .chart-container {
                height: 220px !important;
                margin: 0.3rem auto !important;
                width: 75% !important;
                /* 保持flexbox居中布局 */
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                /* 防止内容溢出 */
                overflow: hidden !important;
            }
            
            /* 确保打印图片在容器内正确居中 */
            .chart-container .print-chart-image {
                display: block !important;
                width: 100% !important;
                height: auto !important;
                max-height: 100% !important;
                object-fit: contain !important;
                /* 高质量图像渲染设置 */
                image-rendering: -webkit-optimize-contrast !important;
                image-rendering: crisp-edges !important;
                image-rendering: pixelated !important; /* 备用选项 */
                image-rendering: high-quality !important; /* 高质量渲染 */
                -ms-interpolation-mode: bicubic !important; /* IE兼容 */
                /* 强制颜色保护 */
                -webkit-print-color-adjust: exact !important;
                color-adjust: exact !important;
                print-color-adjust: exact !important;
                /* 防止图像模糊 */
                backface-visibility: hidden !important;
                -webkit-backface-visibility: hidden !important;
            }
            
            /* 分析图表合并布局优化 - 紧凑上下布局 */
            .analysis-section {
                display: grid !important;
                grid-template-columns: 1fr !important;
                grid-template-rows: auto auto !important;
                gap: 1rem !important;
                page-break-inside: avoid !important;
                margin-bottom: 1.5rem !important;
            }
            
            .analysis-section .result-card {
                margin-bottom: 0 !important;
                padding: 1rem !important;
            }
            
            /* 能力分析标题间距优化 */
            .analysis-section h3 {
                margin-bottom: 0.5rem !important;
                font-size: 1.1rem !important;
            }
            
            /* 科目表现条打印优化 */
            .subject-bar {
                background: linear-gradient(to right, #3b82f6 0%, #1e40af 100%) !important;
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
                border: 1px solid #3b82f6;
            }
            
            /* 分数显示区域重新设计 */
            .score-circle {
                width: auto !important;
                height: auto !important;
                border-radius: 0 !important;
                background: transparent !important;
                border: none !important;
                display: flex !important;
                flex-direction: column !important;
                align-items: center !important;
                padding: 2rem !important;
            }
            
            /* 分数数字显示 - 空白优化版 */
            .score-content {
                text-align: center !important;
                margin-bottom: 0.1rem !important;
            }
            
            /* PDF专用：显示方块网格设计 - 大幅优化空间利用版 */
            .score-blocks-container {
                display: block !important;
                width: 280px !important;
                margin: 0.05rem auto !important;
            }
            
            .score-blocks-grid {
                display: grid !important;
                grid-template-columns: repeat(5, 1fr) !important;
                gap: 3px !important;
                margin-bottom: 0.05rem !important;
            }
            
            .score-block {
                width: 35px !important;
                height: 25px !important;
                border-radius: 4px !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                font-size: 10px !important;
                font-weight: bold !important;
                color: white !important;
                -webkit-print-color-adjust: exact !important;
                color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            .score-block.correct {
                background: #10b981 !important; /* 绿色 - 正确 */
            }
            
            .score-block.incorrect {
                background: #9ca3af !important; /* 灰色 - 错误 */
            }
            
            .score-block.unanswered {
                background: #e5e7eb !important; /* 浅灰色 - 未答 */
                color: #6b7280 !important;
            }
            
            /* 数据统计 - 大幅优化可读版 */
            .score-stats-row {
                display: flex !important;
                justify-content: center !important;
                align-items: center !important;
                gap: 0.4rem !important;
                text-align: center !important;
                font-size: 12px !important;
                color: #1f2937 !important;
                line-height: 1.2 !important;
                margin-top: 0.05rem !important;
            }
            
            .score-stat-card {
                display: inline !important;
                padding: 0.2rem 0.5rem !important;
                background: #f3f4f6 !important;
                border-radius: 4px !important;
                font-weight: bold !important;
                -webkit-print-color-adjust: exact !important;
                color-adjust: exact !important;
                border: 1px solid #e5e7eb !important;
            }
            
            .score-stat-number {
                font-size: 9px !important;
                font-weight: bold !important;
                color: #1f2937 !important;
            }
            
            .score-stat-label {
                display: none !important; /* 隐藏标签，节省空间 */
            }
            
            /* 隐藏原进度条 */
            .score-progress-container,
            .score-progress-fill,
            .score-progress-text {
                display: none !important;
            }
            
            /* 班型推荐打印优化 */
            .class-badge {
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
                border: 2px solid currentColor;
            }
            
            /* 分页控制 */
            .animate-fade-in-up {
                page-break-inside: avoid;
            }
            
            /* 确保表格完整显示 */
            table {
                page-break-inside: avoid;
            }
            
            /* 字体大小调整 */
            h1, h2, h3 {
                page-break-after: avoid;
            }
            
            /* 打印时显示完整题目内容区域 */
            .print-only {
                display: block !important;
            }
            
            /* 题目内容样式 */
            .question-item {
                page-break-inside: avoid;
                margin-bottom: 2rem;
                border: 1px solid #e5e7eb;
                border-radius: 8px;
                padding: 1.5rem;
                background: white !important;
            }
            
            .question-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 1rem;
                padding-bottom: 0.5rem;
                border-bottom: 1px solid #e5e7eb;
            }
            
            .question-number {
                font-size: 1.1rem;
                font-weight: bold;
                color: #1f2937;
            }
            
            .question-subject {
                font-size: 0.875rem;
                color: #6b7280;
                background: #f3f4f6;
                padding: 0.25rem 0.75rem;
                border-radius: 12px;
            }
            
            .question-content {
                margin-bottom: 1rem;
            }
            
            .question-text {
                margin-bottom: 0.75rem;
                line-height: 1.5;
            }
            
            .question-text.chinese {
                color: #374151;
                font-size: 0.95rem;
            }
            
            .question-text.english {
                color: #6b7280;
                font-size: 0.9rem;
                font-style: italic;
            }
            
            .question-options {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 0.5rem;
                margin-bottom: 1rem;
            }
            
            .option-item {
                display: flex;
                align-items: center;
                padding: 0.5rem;
                border: 1px solid #e5e7eb;
                border-radius: 6px;
                background: #f9fafb;
            }
            
            .option-label {
                font-weight: bold;
                margin-right: 0.5rem;
                min-width: 1.5rem;
            }
            
            .question-answers {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-top: 1rem;
                padding-top: 1rem;
                border-top: 1px solid #e5e7eb;
            }
            
            .answer-info {
                display: flex;
                align-items: center;
                gap: 1rem;
            }
            
            .student-answer, .correct-answer {
                display: flex;
                align-items: center;
                gap: 0.5rem;
                font-size: 0.875rem;
            }
            
            .answer-label {
                color: #6b7280;
            }
            
            .answer-value {
                font-weight: bold;
                padding: 0.25rem 0.5rem;
                border-radius: 4px;
            }
            
            .answer-value.correct {
                background: #d1fae5;
                color: #065f46;
                border: 1px solid #10b981;
            }
            
            .answer-value.incorrect {
                background: #fee2e2;
                color: #991b1b;
                border: 1px solid #ef4444;
            }
            
            .answer-value.unanswered {
                background: #f3f4f6;
                color: #6b7280;
                border: 1px solid #d1d5db;
            }
            
            .result-status {
                display: flex;
                align-items: center;
                gap: 0.5rem;
                font-weight: bold;
                font-size: 0.875rem;
            }
            
            .result-status.correct {
                color: #065f46;
            }
            
            .result-status.incorrect {
                color: #991b1b;
            }
            
            .result-status.unanswered {
                color: #6b7280;
            }
            
            /* 分页控制 */
            .page-break-before {
                page-break-before: always;
            }
        }

        /* 弹窗样式 */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            max-width: 90vw;
            max-height: 90vh;
            overflow: auto;
            position: relative;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalIn 0.3s ease-out;
        }

        @keyframes modalIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e5e7eb;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1f2937;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #6b7280;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: #f3f4f6;
            color: #374151;
        }

        .modal-body {
            text-align: center;
        }

        .modal-qr-image {
            max-width: 100%;
            max-height: 400px;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .modal-resources {
            text-align: left;
            background: #f8fafc;
            padding: 1.5rem;
            border-radius: 12px;
            border-left: 4px solid #10b981;
            margin-bottom: 1.5rem;
        }

        .modal-resources h4 {
            color: #047857;
            margin-bottom: 1rem;
            font-size: 1.1rem;
            font-weight: 600;
        }

        /* 免费资料包样式 */
        .free-resources-section {
            background: #f0fdf4;
            border-left: 4px solid #10b981;
        }

        .free-resources-section h4 {
            color: #047857;
        }

        /* 内部专研资料包样式 */
        .premium-resources-section {
            background: #faf5ff;
            border-left: 4px solid #9333ea;
        }

        .premium-resources-section h4 {
            color: #7c3aed;
            display: flex;
            align-items: center;
        }

        /* 内测阶段特殊样式 */
        .premium-preview-section {
            position: relative;
            background: linear-gradient(135deg, #f3e8ff 0%, #ede9fe 100%);
            border: 1px solid #c4b5fd;
        }

        .premium-preview-section::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, #9333ea, #c084fc, #9333ea);
            border-radius: 10px;
            z-index: -1;
            opacity: 0.3;
        }

        /* 资料预览图片悬停效果 */
        .resource-preview-item {
            transition: transform 0.2s ease;
        }

        .resource-preview-item:hover {
            transform: translateY(-2px);
        }

        .resource-preview-item img {
            transition: all 0.2s ease;
        }

        .resource-preview-item:hover img {
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
        }

        .modal-link-box {
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
        }

        .modal-link-box strong {
            color: #1f2937;
            display: block;
            margin-bottom: 0.5rem;
        }

        .modal-link-box a {
            color: #2563eb;
            text-decoration: none;
            word-break: break-all;
        }

        .modal-link-box a:hover {
            text-decoration: underline;
        }

        .modal-extract-code {
            background: #fef3c7;
            color: #d97706;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-weight: bold;
            display: inline-block;
            margin-top: 0.5rem;
        }

        .modal-dual-images {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-top: 1rem;
        }

        .modal-dual-images img {
            width: 100%;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        /* 个人微信二维码添加白色背景 - 全面覆盖所有模态框 */
        .modal-dual-images img[alt*="个人微信"],
        .modal-dual-images img[alt*="老师微信"], 
        .modal-dual-images img[alt*="微信"],
        img[alt*="老师微信二维码"],
        img[alt*="个人微信二维码"],
        img[alt*="微信二维码"],
        .modal-body img[alt*="微信"],
        #study-group-modal img[alt*="个人微信"],
        #study-group-modal img[alt*="微信二维码"] {
            background-color: white !important;
            padding: 8px;
            border-radius: 8px;
        }

        .modal-image-label {
            text-align: center;
            font-weight: 600;
            color: #374151;
            margin-top: 0.5rem;
            font-size: 0.9rem;
        }

        .copy-btn {
            min-width: 70px;
            font-size: 0.875rem;
            cursor: pointer;
            border: none;
            outline: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .copy-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .copy-btn:active {
            transform: translateY(0);
        }

        .copy-btn.copied {
            background-color: #10b981 !important;
        }

        .copy-btn.copied:hover {
            background-color: #059669 !important;
        }

        /* 复制成功提示 */
        .copy-toast {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(16, 185, 129, 0.95);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            z-index: 10000;
            opacity: 0;
            transition: opacity 0.3s ease;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
        }

        .copy-toast.show {
            opacity: 1;
        }

        /* 响应式调整 */
        @media (max-width: 768px) {
            .modal-content {
                margin: 1rem;
                padding: 1.5rem;
            }

            .modal-dual-images {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .copy-btn {
                min-width: 60px;
                font-size: 0.75rem;
                padding: 0.5rem 0.75rem;
            }
        }

        /* 响应式调整 */
        @media (max-width: 768px) {
            .score-circle {
                width: 150px;
                height: 150px;
            }
            
            .score-circle::before {
                width: 120px;
                height: 120px;
            }

            .congratulations-content {
                padding: 2rem 1.5rem;
            }

            .congratulations-name {
                font-size: 2.2rem;
            }

            .congratulations-message {
                font-size: 1rem;
            }

            .congratulations-icon {
                font-size: 3rem;
            }

            .congratulations-grade {
                font-size: 1rem;
                padding: 0.4rem 1.2rem;
            }
        }
    </style>
</head>
<body>
    <!-- 顶部导航 -->
    <nav class="navbar sticky top-0 z-50 no-print">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-3">
                    <div class="nav-brand-icon w-10 h-10 rounded-lg flex items-center justify-center">
                        <i class="fas fa-chart-line text-white text-lg"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-white nav-text-primary">测试结果</h1>
                        <p class="text-sm text-white nav-text-secondary opacity-90" id="user-info">正在加载...</p>
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <!-- 导出按钮 -->
                    <button id="export-pdf" 
                            class="nav-button flex items-center space-x-2 px-4 py-2 rounded-lg transition-all">
                        <i class="fas fa-download"></i>
                        <span class="hidden sm:inline">导出PDF</span>
                    </button>
                    
                    <!-- 重新测试 -->
                    <button id="retake-test" 
                            class="nav-button nav-button-success flex items-center space-x-2 px-4 py-2 rounded-lg transition-all">
                        <i class="fas fa-redo"></i>
                        <span class="hidden sm:inline">重新测试</span>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- 主要内容 -->
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- 祝贺横幅 -->
        <div class="congratulations-banner animate-fade-in-up">
            <div class="congratulations-content">
                <div class="congratulations-icon">
                    🎉
                </div>
                <div class="congratulations-name" id="congratulations-name">
                    恭喜完成测试！
                </div>
                <div class="congratulations-grade" id="congratulations-grade" style="display: none;">
                    <i class="fas fa-graduation-cap mr-2"></i>
                    <span id="grade-text">年级</span>
                </div>
                <div class="congratulations-message" id="congratulations-message">
                    感谢您完成AMC8班前测试，让我们一起来看看您的精彩表现吧！
                </div>
            </div>
        </div>

        <!-- 总体成绩卡片 -->
        <div class="result-card rounded-3xl p-8 mb-8 text-center animate-fade-in-up">
            <div class="grid md:grid-cols-2 gap-8 items-center">
                <!-- 分数展示 -->
                <div class="flex justify-center">
                    <div class="score-circle" id="score-circle">
                        <div class="score-content">
                            <div class="text-4xl font-bold text-gray-900" id="score-display">0</div>
                            <div class="text-lg text-gray-600">/ 25</div>
                        </div>
                        <!-- PDF专用方块设计 -->
                        <div class="score-blocks-container">
                            <!-- 方块网格显示答题情况 -->
                            <div class="score-blocks-grid" id="score-blocks-grid">
                                <!-- 25个方块将通过JavaScript生成 -->
                            </div>
                            
                            <!-- 统计数据 - 单行紧凑显示 -->
                            <div class="score-stats-row">
                                <span class="score-stat-card"><span id="stat-correct">18</span>正确</span>
                                <span class="score-stat-card"><span id="stat-wrong">7</span>错误</span>
                                <span class="score-stat-card"><span id="stat-accuracy">72%</span>得分</span>
                            </div>
                        </div>
                        
                        <!-- 原进度条保留给HTML显示 -->
                        <div class="score-progress-container">
                            <div class="score-progress-fill" id="score-progress-fill"></div>
                            <div class="score-progress-text" id="score-progress-text">0%</div>
                        </div>
                    </div>
                </div>

                <!-- 班型推荐 -->
                <div class="text-center md:text-left">
                    <div class="mb-6">
                        <h2 class="text-3xl font-bold text-gray-900 mb-2">测试成绩分析</h2>
                        <p class="text-gray-600" id="test-summary">正在分析你的测试结果...</p>
                    </div>
                    
                    <div class="class-badge inline-block mb-4" id="class-recommendation">
                        推荐班型加载中...
                    </div>
                    
                    <div class="flex justify-center md:justify-start space-x-6 text-sm">
                        <div class="text-center">
                            <div class="font-semibold text-gray-900" id="answered-count">0</div>
                            <div class="text-gray-500">已答题数</div>
                        </div>
                        <div class="text-center">
                            <div class="font-semibold text-gray-900" id="correct-count">0</div>
                            <div class="text-gray-500">正确题数</div>
                        </div>
                        <div class="text-center">
                            <div class="font-semibold text-gray-900" id="accuracy-rate">0%</div>
                            <div class="text-gray-500">准确率</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 详细分析 -->
        <div class="analysis-section grid lg:grid-cols-2 gap-8 mb-8">
            <!-- 能力雷达图 -->
            <div class="result-card rounded-2xl p-6 animate-fade-in-up animate-delay-200">
                <h3 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
                    <i class="fas fa-chart-radar mr-2 text-blue-600"></i>
                    能力分析
                </h3>
                <div class="chart-container">
                    <canvas id="radar-chart"></canvas>
                </div>
            </div>

            <!-- 科目分析 -->
            <div class="result-card rounded-2xl p-6 animate-fade-in-up animate-delay-400">
                <h3 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
                    <i class="fas fa-chart-bar mr-2 text-green-600"></i>
                    科目表现
                </h3>
                <div id="subject-analysis" class="space-y-4">
                    <!-- 科目分析将通过JavaScript生成 -->
                </div>
            </div>
        </div>

        <!-- 学习建议 -->
        <div class="result-card rounded-2xl p-8 mb-8 animate-fade-in-up animate-delay-600">
            <h3 class="text-2xl font-bold text-gray-900 mb-6 flex items-center">
                <i class="fas fa-lightbulb mr-3 text-yellow-500"></i>
                个性化学习建议
            </h3>
            
            <div class="prose max-w-none">
                <div id="evaluation-text" class="text-gray-700 leading-relaxed whitespace-pre-line mb-6">
                    正在生成个性化评价...
                </div>
                
                <div class="grid md:grid-cols-2 gap-6">
                    <!-- 优势领域 -->
                    <div>
                        <h4 class="text-lg font-semibold text-green-600 mb-3">
                            <i class="fas fa-thumbs-up mr-2"></i>优势领域
                        </h4>
                        <div id="strengths-list" class="space-y-2">
                            <!-- 优势列表将通过JavaScript生成 -->
                        </div>
                    </div>
                    
                    <!-- 提升建议 -->
                    <div>
                        <h4 class="text-lg font-semibold text-red-600 mb-3">
                            <i class="fas fa-arrow-up mr-2"></i>提升建议
                        </h4>
                        <div id="improvements-list" class="space-y-2">
                            <!-- 提升建议将通过JavaScript生成 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 详细题目分析 -->
        <div class="result-card rounded-2xl p-8 animate-fade-in-up animate-delay-600">
            <h3 class="text-2xl font-bold text-gray-900 mb-6 flex items-center">
                <i class="fas fa-list-alt mr-3 text-purple-600"></i>
                详细题目分析
            </h3>
            
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead>
                        <tr class="bg-gray-50 border-b">
                            <th class="text-left py-3 px-4 font-semibold">题号</th>
                            <th class="text-left py-3 px-4 font-semibold">科目</th>
                            <th class="text-left py-3 px-4 font-semibold">难度</th>
                            <th class="text-left py-3 px-4 font-semibold">你的答案</th>
                            <th class="text-left py-3 px-4 font-semibold">正确答案</th>
                            <th class="text-left py-3 px-4 font-semibold">结果</th>
                        </tr>
                    </thead>
                    <tbody id="detailed-results">
                        <!-- 详细结果将通过JavaScript生成 -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 题目内容已移至独立页面 questions-review.html -->
        <!-- 题目内容容器已禁用，题目内容请访问questions-review.html查看 -->
        <!-- <div id="questions-content-container" class="print-only" style="display: none;"></div> -->

        <!-- 查看题目按钮 -->
        <div class="result-card rounded-2xl p-8 text-center mb-8">
            <h3 class="text-2xl font-bold text-gray-900 mb-4">
                <i class="fas fa-list-check mr-3 text-indigo-600"></i>
                查看完整题目与答案
            </h3>
            <p class="text-gray-600 mb-6">回顾所有题目，对比你的答案与正确答案，了解错题原因</p>
            
            <button onclick="viewQuestions()" class="px-8 py-4 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white rounded-lg transition-all transform hover:scale-105 shadow-lg">
                <i class="fas fa-book-open mr-2"></i>
                查看题目与答案解析
            </button>
        </div>

        <!-- 底部行动建议 -->
        <div class="result-card rounded-2xl p-8 text-center no-print">
            <h3 class="text-2xl font-bold text-gray-900 mb-4">下一步行动</h3>
            <p class="text-gray-600 mb-6">根据你的测试表现，我们为你制定了专属的学习路径</p>
            
            <div class="flex flex-wrap justify-center gap-4">
                <button onclick="openModal('consultation-modal')" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-all">
                    <i class="fas fa-phone mr-2"></i>
                    预约咨询
                </button>
                <button onclick="openModal('resources-modal')" class="px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-all">
                    <i class="fas fa-book mr-2"></i>
                    获取学习资料
                </button>
                <button onclick="openModal('study-group-modal')" class="px-6 py-3 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition-all">
                    <i class="fas fa-users mr-2"></i>
                    加入学习群
                </button>
            </div>
        </div>
    </div>

    <!-- 页脚 -->
    <footer class="bg-white bg-opacity-10 backdrop-filter backdrop-blur-lg text-white py-8 mt-16 no-print">
        <div class="max-w-4xl mx-auto px-4 text-center">
            <div class="flex items-center justify-center space-x-3 mb-4">
                <div class="w-8 h-8 bg-white bg-opacity-20 rounded-lg flex items-center justify-center">
                    <i class="fas fa-calculator text-white text-sm"></i>
                </div>
                <span class="font-semibold">AMC8 班前测试系统</span>
            </div>
            <p class="text-gray-200 mb-2">© 2025 Jeff老师. AMC数学竞赛专业培训.</p>
            <p class="text-gray-300 text-sm">本测试结果仅供参考，具体学习安排请咨询专业教师</p>
        </div>
    </footer>

    <!-- 弹窗模态框 -->
    <!-- 预约咨询弹窗 -->
    <div id="consultation-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-phone mr-2 text-blue-600"></i>
                    预约课程咨询
                </h3>
                <button class="modal-close" onclick="closeModal('consultation-modal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <p class="text-gray-600 mb-4">扫描二维码，添加专业课程顾问微信，获取一对一咨询服务</p>
                <img src="images/AMC课程咨询.png" alt="Jeff老师AMC课程咨询二维码" class="modal-qr-image">
                <p class="text-sm text-gray-500 mt-4">
                    <i class="fas fa-clock mr-1"></i>
                    工作时间：周一至周日 9:00-21:00
                </p>
            </div>
        </div>
    </div>

    <!-- 获取学习资料弹窗 -->
    <div id="resources-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-book mr-2 text-green-600"></i>
                    获取学习资料
                </h3>
                <button class="modal-close" onclick="closeModal('resources-modal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <!-- 免费学习资料包 -->
                <div class="modal-resources free-resources-section">
                    <h4>
                        <i class="fas fa-gift mr-2 text-green-600"></i>
                        免费学习资料包
                    </h4>
                    <p class="text-gray-600 mb-4">
                        ✨ Aops数学竞赛23本全套教材带答案 + AMC历年真题库
                    </p>
                    
                    <!-- 免费资料预览图片区域 -->
                    <div class="resources-preview-container mb-6">
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div class="resource-preview-item">
                                <img src="assets/images/resource-preview-1.jpg" alt="Aops教材预览" class="w-full h-32 object-cover rounded-lg shadow-md">
                                <p class="text-xs text-gray-500 text-center mt-1">Aops竞赛教材</p>
                            </div>
                            <div class="resource-preview-item">
                                <img src="assets/images/resource-preview-2.jpg" alt="AMC真题库预览" class="w-full h-32 object-cover rounded-lg shadow-md">
                                <p class="text-xs text-gray-500 text-center mt-1">AMC历年真题</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- VIP用户免费资料下载区域 -->
                    <div id="free-resources-download" class="modal-link-box" style="display: none;">
                        <div class="text-center">
                            <div class="mb-3 p-2 bg-green-50 border border-green-200 rounded-lg">
                                <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                <span class="text-green-700 font-medium">测试完成，免费下载</span>
                            </div>
                            <p class="text-gray-700 mb-2">
                                <strong>📚 网盘链接：</strong><br>
                                <a href="https://pan.baidu.com/s/17lRCTMocne1VhMvQ31D6RQ?pwd=amc8" target="_blank" class="text-blue-600 hover:text-blue-800">
                                    https://pan.baidu.com/s/17lRCTMocne1VhMvQ31D6RQ?pwd=amc8
                                </a>
                            </p>
                            <p class="text-gray-700 mb-4">
                                <strong>🔑 提取码：</strong>
                                <span class="modal-extract-code font-mono bg-gray-100 px-2 py-1 rounded">amc8</span>
                            </p>
                            <button onclick="copyResourcesInfo(this)" 
                                    class="copy-btn flex items-center justify-center space-x-2 mx-auto px-6 py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-all">
                                <i class="fas fa-copy"></i>
                                <span>复制免费资料链接</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- 普通用户加群领取免费资料区域 -->
                    <div id="free-resources-join" class="modal-link-box">
                        <div class="text-center">
                            <div class="mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                                <i class="fas fa-users text-blue-500 text-2xl mb-2"></i>
                                <h5 class="font-medium text-blue-700 mb-2">加入学习群免费领取</h5>
                                <p class="text-sm text-blue-600">扫描下方二维码，添加老师微信，回复"免费资料"即可获取</p>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div class="text-center">
                                    <img src="assets/images/个人微信.jpg" alt="老师微信二维码" class="w-32 h-32 mx-auto rounded-lg shadow-md mb-2">
                                    <p class="text-xs text-gray-500">添加老师微信</p>
                                </div>
                                <div class="text-center">
                                    <img src="assets/images/AMC8-MY强化班介绍.png" alt="课程群二维码" class="w-32 h-32 mx-auto rounded-lg shadow-md mb-2">
                                    <p class="text-xs text-gray-500">了解课程详情</p>
                                </div>
                            </div>
                            
                            <button onclick="closeModal('resources-modal'); openModal('study-group-modal')" 
                                    class="flex items-center justify-center space-x-2 mx-auto px-6 py-3 bg-green-500 hover:bg-green-600 text-white rounded-lg transition-all">
                                <i class="fas fa-users"></i>
                                <span>立即加入学习群</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="mt-4 p-3 bg-amber-50 border-l-4 border-amber-400 rounded">
                        <p class="text-sm text-amber-800">
                            <i class="fas fa-info-circle mr-2"></i>
                            注意：以上免费资料来源于网络，仅供自用交流学习 🌟
                        </p>
                    </div>
                </div>

                <!-- 分隔线 -->
                <div class="my-8 border-t border-gray-200"></div>

                <!-- 魔渊内部专研资料包 -->
                <div class="modal-resources premium-resources-section">
                    <h4>
                        <i class="fas fa-microscope mr-2 text-purple-600"></i>
                        Jeff老师专研资料包
                    </h4>
                    <p class="text-gray-600 mb-4">
                        🔬 教研团队精心研发，专业解析与练习题集
                    </p>
                    
                    <!-- 内部专研资料预览图片区域 -->
                    <div class="resources-preview-container mb-6">
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div class="resource-preview-item">
                                <img src="assets/images/resource-preview-3.jpg" alt="解析答案预览" class="w-full h-48 object-cover rounded-lg shadow-md">
                                <p class="text-xs text-gray-500 text-center mt-1">详细解析答案</p>
                            </div>
                            <div class="resource-preview-item">
                                <img src="assets/images/resource-preview-4.jpg" alt="练习题集预览" class="w-full h-48 object-cover rounded-lg shadow-md">
                                <p class="text-xs text-gray-500 text-center mt-1">专项练习题集</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 内测阶段提示区域 -->
                    <div class="modal-link-box premium-preview-section">
                        <div class="text-center">
                            <div class="mb-4 p-4 bg-purple-50 border border-purple-200 rounded-lg">
                                <i class="fas fa-flask text-purple-500 text-2xl mb-3"></i>
                                <h5 class="font-medium text-purple-700 mb-2">助力高分冲刺 ✨</h5>
                                <div class="bg-purple-100 rounded-lg p-3">
                                    <p class="text-sm text-purple-700 font-medium">
                                        ⭐ 专为AMC8前 5% 冲刺编写<br>
                                        ⭐ 梯度训练 适合个性化学习
                                    </p>
                                </div>
                            </div>
                            
                            <button class="flex items-center justify-center space-x-2 mx-auto px-6 py-3 bg-purple-500 hover:bg-purple-600 text-white rounded-lg transition-all cursor-not-allowed opacity-75" disabled>
                                <i class="fas fa-hourglass-half"></i>
                                <span>内部资料，课程专用</span>
                            </button>
                        </div>
                    </div>
                    
                </div>
            </div>
        </div>
    </div>

    <!-- 加入学习群弹窗 -->
    <div id="study-group-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-users mr-2 text-purple-600"></i>
                    加入学习群
                </h3>
                <button class="modal-close" onclick="closeModal('study-group-modal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <p class="text-gray-600 mb-4">加入我们的学习群，与优秀学员一起进步！</p>
                
                <div class="modal-dual-images">
                    <div>
                        <img src="assets/images/AMC8-MY强化班介绍.png" alt="AMC8强化班介绍">
                        <div class="modal-image-label">课程介绍</div>
                    </div>
                    <div>
                        <img src="assets/images/个人微信.jpg" alt="个人微信二维码">
                        <div class="modal-image-label">添加老师微信</div>
                    </div>
                </div>
                
                <div class="mt-4 p-3 bg-purple-50 border-l-4 border-purple-400 rounded">
                    <p class="text-sm text-purple-800">
                        <i class="fas fa-star mr-2"></i>
                        扫描右侧二维码添加老师微信，获取学习群邀请和专业指导
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // 动态加载JavaScript文件 - 环境适配
        function loadScriptsWithFallback() {
            const isDeployed = window.location.hostname !== 'localhost' && 
                              window.location.hostname !== '127.0.0.1' &&
                              !window.location.protocol.includes('file:');
            
            const basePath = isDeployed ? 'js/' : 'assets/js/';
            const scripts = ['test-engine.js', 'scoring-engine.js', 'result-display.js'];
            
            return Promise.all(scripts.map(scriptName => {
                return new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = basePath + scriptName;
                    script.onload = () => {
                        console.log(`已加载: ${basePath}${scriptName}`);
                        resolve();
                    };
                    script.onerror = (error) => {
                        console.error(`加载失败: ${basePath}${scriptName}`, error);
                        reject(new Error(`无法加载 ${basePath}${scriptName}`));
                    };
                    document.head.appendChild(script);
                });
            }));
        }

        // 页面加载时执行脚本加载和初始化
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                console.log('开始加载JavaScript依赖...');
                await loadScriptsWithFallback();
                console.log('JavaScript依赖加载完成，开始初始化结果页面...');
                
                // 现在可以安全地初始化结果页面
                await initializeResultPage();
            } catch (error) {
                console.error('JavaScript依赖加载失败:', error);
                alert('系统加载失败，请重新测试。错误详情：' + error.message);
                window.location.href = 'index.html';
            }
        });

        // 将原来的初始化代码移到单独的函数中
        async function initializeResultPage() {
            try {
                console.log('开始初始化结果页面...');
                
                // 检查是否有测试结果
                console.log('正在加载localStorage数据...');
                const answers = JSON.parse(localStorage.getItem('amc8_test_answers') || '{}');
                const userInfo = JSON.parse(localStorage.getItem('amc8_user_info') || '{}');
                console.log('localStorage数据加载成功', { answersKeys: Object.keys(answers), userInfo });
                
                // 保存用户信息到全局变量
                globalUserInfo = userInfo;
                
                // 检查是否有用户信息（表示经过了测试流程）
                // 允许0个答案的情况，这表示用户交了白卷
                if (!userInfo.name || !userInfo.phone) {
                    console.log('用户信息不完整，重定向到首页');
                    alert('没有找到测试记录，请先开始测试');
                    window.location.href = 'index.html';
                    return;
                }
                
                // 记录答案数量用于调试
                const answerCount = Object.keys(answers).filter(key => !key.startsWith('_')).length;
                console.log(`用户答题数量: ${answerCount}/25`);

                // 检查是否为测试模式
                const isTestMode = localStorage.getItem('amc8_test_mode') === 'true';
                console.log('测试模式状态:', isTestMode);
                
                try {
                    console.log('开始更新用户信息显示...');
                    // 显示用户信息
                    if (userInfo.name) {
                        let userInfoText = `${userInfo.name} | ${userInfo.grade}年级`;
                        if (isTestMode) {
                            userInfoText += ' | 🧪 测试模式';
                        }
                        const userInfoElement = document.getElementById('user-info');
                        if (userInfoElement) {
                            userInfoElement.textContent = userInfoText;
                            console.log('用户信息显示成功');
                        } else {
                            console.warn('未找到user-info元素');
                        }
                        
                        // 更新祝贺横幅
                        console.log('开始更新祝贺横幅...');
                        updateCongratulationsBanner(userInfo);
                        console.log('祝贺横幅更新完成');
                    }

                    // 如果是测试模式，显示测试模式提示
                    if (isTestMode) {
                        console.log('显示测试模式通知...');
                        showTestModeNotification(userInfo);
                        console.log('测试模式通知显示完成');
                    }
                } catch (uiError) {
                    console.error('UI更新失败:', uiError);
                    throw uiError;
                }

                try {
                    console.log('开始初始化评分引擎...');
                    // 检查ScoringEngine是否已定义
                    if (typeof ScoringEngine === 'undefined') {
                        throw new Error('ScoringEngine未定义，可能是scoring-engine.js加载失败');
                    }
                    
                    // 初始化评分引擎
                    const scoringEngine = new ScoringEngine();
                    await scoringEngine.initialize();
                    console.log('评分引擎初始化完成');

                    console.log('开始生成测试报告...');
                    // 生成完整报告
                    const report = scoringEngine.generateFullReport(answers, userInfo);
                    console.log('测试报告生成完成:', report);
                    
                    // 保存报告到全局变量
                    globalReport = report;
                } catch (scoringError) {
                    console.error('评分引擎失败:', scoringError);
                    throw scoringError;
                }
                
                try {
                    console.log('开始显示测试结果...');
                    // 检查ResultDisplay是否已定义
                    if (typeof ResultDisplay === 'undefined') {
                        throw new Error('ResultDisplay未定义，可能是result-display.js加载失败');
                    }
                    
                    // 显示结果
                    const resultDisplay = new ResultDisplay();
                    window.resultDisplay = resultDisplay; // 保存引用供PDF导出使用
                    resultDisplay.displayResults(globalReport);
                    console.log('测试结果显示完成');
                    
                    console.log('开始设置进度条和方块网格...');
                    // 设置进度条（HTML显示）
                    setScoreProgressBar(globalReport.percentage);
                    
                    // 设置方块网格（PDF专用）
                    setScoreBlocks(globalReport);
                    console.log('进度条和方块网格设置完成');
                    
                    console.log('结果页面初始化完全成功');
                } catch (displayError) {
                    console.error('结果显示失败:', displayError);
                    throw displayError;
                }

            } catch (error) {
                console.error('初始化结果页面失败:', error);
                console.error('错误详细信息:', error.message);
                console.error('错误堆栈:', error.stack);
                alert('结果页面加载失败，请重新测试。错误详情：' + error.message);
                window.location.href = 'index.html';
            }
        }
    </script>
    
    <script>
        // 图片路径环境检测和自动适配
        function getImagePath() {
            // 检测是否为部署环境
            const isDeployed = window.location.hostname !== 'localhost' && 
                              window.location.hostname !== '127.0.0.1' &&
                              !window.location.hostname.includes('file://') &&
                              window.location.protocol !== 'file:';
            
            return isDeployed ? 'images/' : 'assets/images/';
        }

        // 动态更新图片路径
        function updateImagePaths() {
            const imagePath = getImagePath();
            const images = document.querySelectorAll('img[src*="assets/images/"], img[src*="images/"]');
            
            images.forEach(img => {
                const srcParts = img.src.split('/');
                const filename = srcParts[srcParts.length - 1];
                // 只更新包含我们目标路径的图片
                if (img.src.includes('assets/images/') || img.src.includes('images/')) {
                    img.src = imagePath + filename;
                }
            });
        }

        // 页面加载完成后执行路径更新
        document.addEventListener('DOMContentLoaded', updateImagePaths);
    </script>
    
    <script>
        // 弹窗功能函数
        async function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                // 如果是学习资料模态框，需要检查用户权限
                if (modalId === 'resources-modal') {
                    await checkUserPermissionAndShowResources();
                }
                
                modal.classList.add('show');
                document.body.style.overflow = 'hidden'; // 禁止背景滚动
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('show');
                document.body.style.overflow = ''; // 恢复背景滚动
            }
        }

        // 点击遮罩层关闭弹窗
        document.addEventListener('click', function(event) {
            if (event.target.classList.contains('modal-overlay')) {
                closeModal(event.target.id);
            }
        });

        // ESC键关闭弹窗
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                // 查找当前打开的弹窗并关闭
                const openModal = document.querySelector('.modal-overlay.show');
                if (openModal) {
                    closeModal(openModal.id);
                }
            }
        });

        // 复制学习资料信息功能
        function copyResourcesInfo(button) {
            const resourcesText = `📚 通过百度网盘分享的文件：  
✨ Aops数学竞赛23本全套教材带答案 + AMC真题库  

🔗 链接: https://pan.baidu.com/s/17lRCTMocne1VhMvQ31D6RQ?pwd=amc8  
🔑 提取码: amc8`;
            
            copyToClipboard(resourcesText, button);
        }

        // 复制到剪贴板功能
        function copyToClipboard(text, button) {
            // 现代浏览器使用 Clipboard API
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(text).then(() => {
                    showCopySuccess(button, text);
                }).catch((err) => {
                    console.error('复制失败:', err);
                    fallbackCopy(text, button);
                });
            } else {
                // 兼容旧浏览器
                fallbackCopy(text, button);
            }
        }

        // 兼容方案：创建临时input元素复制
        function fallbackCopy(text, button) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.top = '0';
            textArea.style.left = '0';
            textArea.style.width = '2em';
            textArea.style.height = '2em';
            textArea.style.padding = '0';
            textArea.style.border = 'none';
            textArea.style.outline = 'none';
            textArea.style.boxShadow = 'none';
            textArea.style.background = 'transparent';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showCopySuccess(button, text);
                } else {
                    showCopyError();
                }
            } catch (err) {
                console.error('复制失败:', err);
                showCopyError();
            }
            
            document.body.removeChild(textArea);
        }

        // 显示复制成功效果
        function showCopySuccess(button, text) {
            // 更新按钮状态
            const originalHTML = button.innerHTML;
            button.classList.add('copied');
            button.innerHTML = '<i class="fas fa-check"></i><span>已复制</span>';
            
            // 显示toast提示
            showToast(`已复制：${text.length > 50 ? text.substring(0, 50) + '...' : text}`);
            
            // 2秒后恢复按钮状态
            setTimeout(() => {
                button.classList.remove('copied');
                button.innerHTML = originalHTML;
            }, 2000);
        }

        // 显示复制错误
        function showCopyError() {
            showToast('复制失败，请手动复制', 'error');
        }

        // 显示toast提示
        function showToast(message, type = 'success') {
            // 移除现有toast
            const existingToast = document.querySelector('.copy-toast');
            if (existingToast) {
                existingToast.remove();
            }
            
            // 创建新toast
            const toast = document.createElement('div');
            toast.className = 'copy-toast';
            toast.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} mr-2"></i>${message}`;
            
            if (type === 'error') {
                toast.style.background = 'rgba(239, 68, 68, 0.95)';
                toast.style.boxShadow = '0 8px 25px rgba(239, 68, 68, 0.3)';
            }
            
            document.body.appendChild(toast);
            
            // 显示动画
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            
            // 3秒后隐藏
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }

        // 全局变量存储用户信息和测试报告
        let globalUserInfo = {};
        let globalReport = {};

        // 检查用户权限并显示对应资源
        async function checkUserPermissionAndShowResources() {
            try {
                // 获取当前用户信息
                const userInfo = JSON.parse(localStorage.getItem('amc8_user_info') || '{}');
                const answers = JSON.parse(localStorage.getItem('amc8_test_answers') || '{}');
                const phoneNumber = userInfo.phone || '';
                
                console.log('检查用户权限，手机号：', phoneNumber);
                
                if (!phoneNumber) {
                    // 没有手机号，显示普通用户界面
                    showRegularUserResources();
                    return;
                }
                
                // 检查是否完成了测试
                const hasCompletedTest = Object.keys(answers).filter(key => !key.startsWith('_')).length > 0;
                console.log('用户是否完成测试：', hasCompletedTest);
                
                // 检查JSON文件中的VIP用户列表
                let isVIPUser = false;
                try {
                    const response = await fetch('assets/data/registered-users.json');
                    if (response.ok) {
                        const userData = await response.json();
                        const registeredUser = userData.registeredUsers.find(user => user.phone === phoneNumber);
                        
                        if (registeredUser && (registeredUser.permission === 'vip' || registeredUser.permission === 'premium')) {
                            isVIPUser = true;
                            console.log('发现VIP用户：', registeredUser.name, '权限：', registeredUser.permission);
                            showCompletedUserResources(registeredUser);
                            return;
                        }
                    }
                } catch (error) {
                    console.warn('无法加载VIP用户列表：', error);
                }
                
                // 如果不是VIP用户，但已完成测试，可以下载免费资料
                if (hasCompletedTest) {
                    console.log('用户已完成测试，显示免费资料下载界面');
                    showCompletedUserResources({name: userInfo.name, phone: phoneNumber, permission: 'completed_test'});
                } else {
                    console.log('用户未完成测试，显示普通用户界面');
                    showRegularUserResources();
                }
                
            } catch (error) {
                console.error('权限验证失败：', error);
                showRegularUserResources(); // 出错时显示普通用户界面
            }
        }

        // 显示完成测试用户资源（可下载免费资料）
        function showCompletedUserResources(userInfo) {
            // 显示免费资料下载区域
            const freeDownloadSection = document.getElementById('free-resources-download');
            const freeJoinSection = document.getElementById('free-resources-join');
            
            if (freeDownloadSection && freeJoinSection) {
                freeDownloadSection.style.display = 'block';
                freeJoinSection.style.display = 'none';
                
                // 根据权限类型更新提示文本
                const freeBadge = freeDownloadSection.querySelector('.mb-3.p-2');
                if (freeBadge && userInfo.permission === 'vip') {
                    freeBadge.innerHTML = '<i class="fas fa-crown text-yellow-500 mr-2"></i><span class="text-green-700 font-medium">VIP用户专享，免费下载</span>';
                }
                
                console.log(`显示完成测试用户免费资料下载 - ${userInfo.name} (${userInfo.permission})`);
            }
            
            // 内部专研资料永远只显示预览（内测阶段）
            console.log('内部专研资料：显示预览模式（内测阶段）');
        }

        // 显示普通用户资源（需要加群）
        function showRegularUserResources() {
            // 显示免费资料加群引导
            const freeDownloadSection = document.getElementById('free-resources-download');
            const freeJoinSection = document.getElementById('free-resources-join');
            
            if (freeDownloadSection && freeJoinSection) {
                freeDownloadSection.style.display = 'none';
                freeJoinSection.style.display = 'block';
                
                console.log('显示普通用户免费资料加群界面');
            }
            
            // 内部专研资料永远只显示预览（内测阶段）
            console.log('内部专研资料：显示预览模式（内测阶段）');
        }

        // 设置进度条宽度和样式（HTML显示）
        function setScoreProgressBar(percentage) {
            const progressFill = document.getElementById('score-progress-fill');
            
            if (progressFill) {
                // 设置进度条宽度
                progressFill.style.width = percentage + '%';
                
                // 根据百分比设置颜色 - 使用纯色确保PDF兼容性
                let color;
                if (percentage >= 80) {
                    color = '#10b981'; // green
                } else if (percentage >= 60) {
                    color = '#3b82f6'; // blue  
                } else if (percentage >= 40) {
                    color = '#f59e0b'; // orange
                } else {
                    color = '#ef4444'; // red
                }
                
                // 使用纯色而不是渐变，确保PDF兼容性
                progressFill.style.background = color;
                
                // 强制PDF颜色保护
                progressFill.style.webkitPrintColorAdjust = 'exact';
                progressFill.style.colorAdjust = 'exact';
                
                console.log(`设置进度条: ${percentage}% -> 宽度:${percentage}%, 颜色:${color}`);
            }
        }
        
        // 设置方块网格显示（PDF专用）
        function setScoreBlocks(report) {
            const blocksGrid = document.getElementById('score-blocks-grid');
            const statCorrect = document.getElementById('stat-correct');
            const statWrong = document.getElementById('stat-wrong');
            const statAccuracy = document.getElementById('stat-accuracy');
            
            if (blocksGrid && report) {
                // 清空现有方块
                blocksGrid.innerHTML = '';
                
                // 生成25个方块
                for (let i = 1; i <= 25; i++) {
                    const block = document.createElement('div');
                    block.className = 'score-block';
                    block.textContent = i;
                    
                    if (i <= report.correctAnswers) {
                        block.classList.add('correct');
                    } else if (i <= report.answeredQuestions) {
                        block.classList.add('incorrect');
                    } else {
                        block.classList.add('unanswered');
                        block.textContent = '-';
                    }
                    
                    blocksGrid.appendChild(block);
                }
                
                // 更新统计数据
                if (statCorrect) statCorrect.textContent = report.correctAnswers;
                if (statWrong) statWrong.textContent = report.answeredQuestions - report.correctAnswers;
                if (statAccuracy) statAccuracy.textContent = Math.round(report.percentage) + '%';
                
                console.log(`设置方块网格: 正确${report.correctAnswers}题, 总答${report.answeredQuestions}题`);
            }
        }

        // 更新祝贺横幅
        function updateCongratulationsBanner(userInfo) {
            const nameElement = document.getElementById('congratulations-name');
            const gradeElement = document.getElementById('congratulations-grade');
            const gradeTextElement = document.getElementById('grade-text');
            const messageElement = document.getElementById('congratulations-message');
            
            if (userInfo.name) {
                // 将年级信息直接集成到姓名中，使用更紧凑的布局
                if (userInfo.grade) {
                    nameElement.innerHTML = `恭喜 ${userInfo.name} 同学！ <span class="inline-flex items-center ml-3 px-3 py-1 text-sm bg-white bg-opacity-20 rounded-full border border-white border-opacity-30"><i class="fas fa-graduation-cap mr-1"></i>${userInfo.grade}年级</span>`;
                    gradeElement.style.display = 'none'; // 隐藏原来的年级元素
                } else {
                    nameElement.textContent = `恭喜 ${userInfo.name} 同学！`;
                    gradeElement.style.display = 'none';
                }
                
                messageElement.textContent = '感谢您完成AMC8班前测试，让我们一起来看看您的精彩表现吧！';
            } else {
                nameElement.textContent = '恭喜完成测试！';
                gradeElement.style.display = 'none';
                messageElement.textContent = '感谢您完成AMC8班前测试，让我们一起来看看您的精彩表现吧！';
            }
        }

        // 导出PDF功能
        document.getElementById('export-pdf').addEventListener('click', async function() {
            // 生成带用户信息的PDF文件名
            const fileName = generatePDFFileName();
            
            // 暂时更新页面标题为PDF文件名
            const originalTitle = document.title;
            document.title = fileName;
            
            // 题目内容已移至独立页面 questions-review.html
            // PDF导出只包含成绩单，不包含题目内容
            console.log('PDF导出：成绩单模式（不包含题目内容）');
            
            // 确保图表已准备好再打印
            preparePrintCharts().then(() => {
                // 添加打印前的准备工作
                document.body.classList.add('printing');
                
                // 执行打印
                window.print();
                
                // 打印完成后清理
                setTimeout(() => {
                    document.body.classList.remove('printing');
                    // 恢复原标题
                    document.title = originalTitle;
                }, 1000);
            }).catch(error => {
                console.error('准备打印图表失败:', error);
                // 即使出错也允许打印
                window.print();
                // 恢复原标题
                document.title = originalTitle;
            });
        });

        // 生成PDF文件名
        function generatePDFFileName() {
            const userInfo = globalUserInfo;
            const report = globalReport;
            const currentDate = new Date();
            
            // 格式化日期
            const dateStr = currentDate.toLocaleDateString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            }).replace(/\//g, '-');
            
            let fileName = '';
            
            if (userInfo.name) {
                // 如果有用户姓名，包含在文件名中
                fileName = `${userInfo.name}_AMC8测试报告_${dateStr}`;
                
                // 如果有年级信息，也添加到文件名中
                if (userInfo.grade) {
                    fileName = `${userInfo.name}_${userInfo.grade}年级_AMC8测试报告_${dateStr}`;
                }
                
                // 如果有分数信息，添加分数
                if (report && report.score !== undefined) {
                    fileName = `${userInfo.name}_AMC8测试报告_${report.score}分_${dateStr}`;
                    
                    if (userInfo.grade) {
                        fileName = `${userInfo.name}_${userInfo.grade}年级_AMC8测试报告_${report.score}分_${dateStr}`;
                    }
                }
            } else {
                // 如果没有用户姓名，使用通用格式
                if (report && report.score !== undefined) {
                    fileName = `AMC8测试报告_${report.score}分_${dateStr}`;
                } else {
                    fileName = `AMC8测试报告_${dateStr}`;
                }
            }
            
            return fileName;
        }
        
        // 准备打印图表
        async function preparePrintCharts() {
            return new Promise((resolve) => {
                // 检查雷达图是否已生成打印图片
                const chartContainer = document.querySelector('.chart-container');
                const printImage = chartContainer ? chartContainer.querySelector('.print-chart-image') : null;
                
                if (printImage && printImage.src) {
                    console.log('打印图表已准备就绪');
                    resolve();
                } else {
                    // 如果没有打印图片，尝试重新生成
                    const canvas = document.getElementById('radar-chart');
                    if (canvas && window.resultDisplay) {
                        try {
                            window.resultDisplay.generatePrintImage(canvas);
                            // 给图片加载一些时间
                            setTimeout(resolve, 500);
                        } catch (error) {
                            console.warn('无法生成打印图片:', error);
                            resolve();
                        }
                    } else {
                        resolve();
                    }
                }
            });
        }

        // 查看题目与答案
        function viewQuestions() {
            // 跳转到题目答案对照页面
            window.location.href = 'questions-review.html';
        }

        // 重新测试功能
        document.getElementById('retake-test').addEventListener('click', function() {
            if (confirm('确定要重新测试吗？当前结果将被清除。')) {
                // 清除本地存储的数据
                localStorage.removeItem('amc8_test_answers');
                localStorage.removeItem('amc8_timer_state');
                
                // 跳转到首页
                window.location.href = 'index.html';
            }
        });

        // 显示测试模式通知
        function showTestModeNotification(userInfo) {
            // 创建测试模式通知框
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-yellow-500 text-white px-6 py-4 rounded-lg shadow-lg z-50 max-w-sm';
            notification.innerHTML = `
                <div class="flex items-start">
                    <i class="fas fa-flask text-xl mr-3 mt-1"></i>
                    <div>
                        <h4 class="font-bold mb-1">测试模式运行中</h4>
                        <p class="text-sm">
                            答案模式: ${userInfo.answerMode || 'random'}<br>
                            答题数量: ${userInfo.answerCount || 25}题
                        </p>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                                class="mt-2 text-xs bg-yellow-600 hover:bg-yellow-700 px-2 py-1 rounded">
                            关闭
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // 10秒后自动消失
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 10000);
        }
    </script>
</body>
</html>